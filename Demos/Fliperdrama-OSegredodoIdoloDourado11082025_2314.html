<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fl iperdrama: O Segredo do √çdolo Dourado</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Roboto+Mono:wght@400;700&family=Lora:ital,wght@0,400;0,700;1,400&family=Creepster&display=swap" rel="stylesheet">
    <style>
        /* --- Tema Cyberpunk (Tela Inicial) --- */
        :root {
            --screen-bg: #0a0f18;
            --card-bg: rgba(10, 15, 24, 0.8);
            --text-color: #96e072;
            --glow-color: rgba(50, 255, 126, 0.5);
            --border-color: rgba(50, 255, 126, 0.2);
            --button-bg: rgba(50, 255, 126, 0.1);
            --button-hover-bg: rgba(50, 255, 126, 0.2);
        }
        body {
            background-color: var(--screen-bg);
            color: var(--text-color);
            font-family: 'Roboto Mono', monospace;
            transition: background-color 0.8s ease, color 0.8s ease;
        }
        .scanlines {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0) 50%, rgba(0,0,0,0.1) 50%, rgba(0,0,0,0.1));
            background-size: 100% 4px;
            animation: scan 0.2s linear infinite;
        }
        @keyframes scan {
            from { background-position: 0 0; }
            to { background-position: 0 4px; }
        }
        .crt-glow {
            box-shadow: 0 0 20px var(--glow-color);
        }
        .font-display-cyber { font-family: 'Orbitron', sans-serif; }
        .card {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            backdrop-filter: blur(5px);
            transition: background-color 0.5s ease, border-color 0.5s ease;
        }
        .typing-effect::after {
            content: '‚ñà';
            animation: blink 1s step-end infinite;
        }
        @keyframes blink {
            50% { opacity: 0; }
        }
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.2);
            border-left-color: var(--text-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* --- Tema Allen (Horror Cl√°ssico) --- */
        body.theme-allen {
            --screen-bg: #fdf6e3;
            --card-bg: rgba(243, 234, 217, 0.8);
            --text-color: #586e75;
            --glow-color: rgba(181, 137, 0, 0.4);
            --border-color: #eee8d5;
            --button-bg: rgba(181, 137, 0, 0.05);
            --button-hover-bg: rgba(181, 137, 0, 0.15);
        }
        body.theme-allen .scanlines, body.theme-burton .scanlines { display: none; }
        body.theme-allen .crt-glow { box-shadow: 0 2px 15px rgba(0,0,0,0.1); }
        body.theme-allen .font-display, body.theme-burton .font-display { font-family: 'Lora', serif; }
        body.theme-allen .card, body.theme-burton .card {
            background-color: var(--card-bg);
            border-color: var(--border-color);
        }
        body.theme-allen .spinner { border-left-color: #b58900; }
        
        /* --- Tema Burton (Horror Bizarro) --- */
        body.theme-burton {
            --screen-bg: #1a1d24;
            --card-bg: rgba(10, 10, 15, 0.7);
            --text-color: #c0c5ce;
            --glow-color: rgba(108, 99, 255, 0.4);
            --border-color: #3b4252;
            --button-bg: rgba(108, 99, 255, 0.1);
            --button-hover-bg: rgba(108, 99, 255, 0.2);
        }
        body.theme-burton .font-display { font-family: 'Creepster', cursive; letter-spacing: 1px; }
        body.theme-burton .spinner { border-left-color: #6c63ff; }
        body.theme-burton .gemini-button {
             background-color: #2e3440;
             color: #d8dee9;
             border-color: #4c566a;
        }
        body.theme-burton .gemini-button:hover { background-color: #4c566a; }

        .choice-button {
            border: 1px solid var(--border-color);
            background-color: var(--button-bg);
            transition: all 0.2s ease-in-out;
        }
        .choice-button:hover {
            background-color: var(--button-hover-bg);
            box-shadow: 0 0 10px var(--glow-color);
        }
        .choice-button-allen {
            border-color: #dc322f;
            color: #dc322f;
        }
        .choice-button-allen:hover {
            background-color: rgba(220, 50, 47, 0.1);
            box-shadow: 0 0 10px rgba(220, 50, 47, 0.4);
        }
        .choice-button-burton {
            border-color: #268bd2;
            color: #268bd2;
        }
        .choice-button-burton:hover {
            background-color: rgba(38, 139, 210, 0.1);
            box-shadow: 0 0 10px rgba(38, 139, 210, 0.4);
        }
        .gemini-button {
            background-color: #eee8d5;
            color: #657b83;
            border: 1px solid #d3c5a8;
        }
        .gemini-button:hover {
            background-color: #d3c5a8;
        }
        .modal-bg {
            background-color: rgba(10, 15, 24, 0.8);
            backdrop-filter: blur(10px);
        }
        .examinable {
            color: #cb4b16;
            text-decoration: underline;
            text-decoration-style: dotted;
            cursor: pointer;
        }
        .custom-select {
            background-color: var(--button-bg);
            border: 1px solid var(--border-color);
            color: var(--text-color);
        }
    </style>
</head>
<body class="antialiased">
    <div class="scanlines"></div>

    <div id="start-screen" class="min-h-screen flex flex-col items-center justify-center text-center p-4">
        <div class="card rounded-lg shadow-lg p-8 crt-glow max-w-3xl relative">
            <button id="api-key-button" title="Inserir Chave de API" class="absolute top-4 right-4 text-gray-400 hover:text-white">üîë</button>
            <h1 class="font-display-cyber text-3xl md:text-5xl text-white">CARREGANDO FLIPERDRAMA...</h1>
            <p class="mt-2 text-lg">> PRONTO</p>
            <p class="mt-6 text-xl font-bold font-display-cyber">> T√çTULO: O SEGREDO DO √çDOLO DOURADO</p>
            <p class="mt-2">> FORMATO: ARCADRAMA / S√âRIE INTERATIVA (PULP_BOOK)</p>
            <p class="mt-6 text-sm">AVISO: As escolhas a seguir ir√£o modular a sua assinatura ps√≠quica. A realidade √© subjetiva. A garantia c√≥smica n√£o cobre danos existenciais. Proceda com cautela e um saud√°vel sentido de absurdo.</p>
            <p class="mt-4 text-xs text-gray-400">Nota: As funcionalidades de IA (‚ú®) podem ser bloqueadas por alguns navegadores quando o ficheiro √© aberto localmente (file://). Para uma experi√™ncia completa, recomenda-se a execu√ß√£o a partir de um servidor web.</p>
            <button id="start-button" class="mt-8 px-8 py-3 choice-button font-bold rounded-lg text-lg">
                INICIAR NARRATIVA
            </button>
        </div>
    </div>

    <main id="game-screen" class="hidden w-full max-w-7xl mx-auto p-4 md:p-8">
        <div class="card rounded-lg shadow-lg p-6 md:p-8 crt-glow">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div>
                    <div id="narrative-panel" class="mb-8 relative">
                        <h2 id="scene-title" class="font-display text-2xl border-b-2 pb-2 mb-4" style="border-color: var(--border-color);"></h2>
                        <div id="tts-controls" class="absolute top-0 right-0"></div>
                        <div id="scene-content" class="text-lg leading-relaxed space-y-4"></div>
                    </div>
                    <div id="choice-panel">
                         <p class="text-center text-sm text-gray-400 mb-4">//: A percep√ß√£o molda a realidade. Escolha uma lente.</p>
                         <div id="choices-container" class="space-y-4"></div>
                    </div>
                </div>
                <div id="image-panel" class="hidden">
                    <h3 class="font-display text-xl mb-4">VISUALIZADOR DE CENA</h3>
                    <div id="image-container" class="relative group">
                        <div id="image-display-area" class="w-full h-80 bg-black/5 flex items-center justify-center rounded-md mb-4 border" style="border-color: var(--border-color);">
                            <p class="text-gray-500 text-sm p-4 text-center">Escolha uma vis√£o para gerar uma ilustra√ß√£o.</p>
                        </div>
                        <div id="image-toolbar" class="absolute bottom-6 right-2 flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                            <button id="fullscreen-button" title="Tela Cheia" class="p-2 gemini-button rounded-full hidden"><svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 1v4m0 0h-4m4 0l-5-5" /></svg></button>
                            <a id="download-link" href="#" download="fliperdrama-cena.png" title="Baixar Imagem" class="p-2 gemini-button rounded-full hidden"><svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg></a>
                        </div>
                    </div>
                    <div id="image-options-container" class="space-y-3"></div>
                </div>
            </div>
        </div>
    </main>

    <div id="precog-modal" class="fixed inset-0 z-50 items-center justify-center hidden">
        <div class="modal-bg absolute inset-0"></div>
        <div class="relative card rounded-lg shadow-2xl max-w-lg w-11/12 p-6 border-2" style="border-color: #d3c5a8;">
            <h3 class="font-display text-xl text-gray-700 mb-4">‚ú® PRECOGNI√á√ÉO ATIVADA...</h3>
            <div id="precog-content" class="text-base text-gray-600 h-32 overflow-y-auto"></div>
            <button id="modal-close-precog-button" class="mt-4 px-6 py-2 gemini-button rounded-lg w-full">FECHAR CANAL</button>
        </div>
    </div>
    
    <div id="investigation-modal" class="fixed inset-0 z-50 items-center justify-center hidden">
        <div class="modal-bg absolute inset-0"></div>
        <div class="relative card rounded-lg shadow-2xl max-w-lg w-11/12 p-6 border-2" style="border-color: #cb4b16;">
            <h3 id="investigation-title" class="font-display text-xl text-gray-700 mb-4"></h3>
            <div id="investigation-content" class="text-base text-gray-600 h-40 overflow-y-auto"></div>
            <button id="modal-close-investigation-button" class="mt-4 px-6 py-2 gemini-button rounded-lg w-full">FECHAR ARQUIVO</button>
        </div>
    </div>

    <div id="character-chat-modal" class="fixed inset-0 z-50 items-center justify-center hidden">
        <div class="modal-bg absolute inset-0"></div>
        <div class="relative card rounded-lg shadow-2xl max-w-lg w-11/12 p-6 border-2 flex flex-col" style="border-color: #6c71c4;">
            <h3 id="chat-title" class="font-display text-xl text-gray-700 mb-4 flex-shrink-0"></h3>
            <div id="chat-log" class="flex-grow h-64 overflow-y-auto mb-4 p-2 bg-black/5 border" style="border-color: var(--border-color);"></div>
            <div class="flex-shrink-0 flex gap-2">
                <input type="text" id="chat-input" class="flex-grow bg-white/50 border text-gray-700 p-2 rounded-md" style="border-color: var(--border-color);" placeholder="Fa√ßa uma pergunta...">
                <button id="chat-send-button" class="gemini-button px-4 rounded-md">Enviar</button>
            </div>
             <button id="modal-close-chat-button" class="mt-4 px-6 py-2 gemini-button rounded-lg w-full">ENCERRAR CONVERSA</button>
        </div>
    </div>

    <div id="api-key-modal" class="fixed inset-0 z-50 items-center justify-center hidden">
        <div class="modal-bg absolute inset-0"></div>
        <div class="relative card rounded-lg shadow-2xl max-w-lg w-11/12 p-6 border-2">
            <h3 class="font-display-cyber text-xl text-white mb-4">CONFIGURAR CHAVE DE API</h3>
            <p class="text-sm mb-4">Parece que as chamadas √† API est√£o a falhar. Isto pode acontecer ao executar o ficheiro localmente. Por favor, insira a sua chave de API da Google AI Studio para continuar.</p>
            <input type="text" id="api-key-input" class="w-full bg-black/50 border p-2 rounded-md" placeholder="Cole a sua chave de API aqui...">
            <div class="flex gap-4 mt-4">
                <button id="save-api-key-button" class="flex-grow px-6 py-2 choice-button rounded-lg">Guardar Chave</button>
                <button id="close-api-key-modal" class="px-6 py-2 gemini-button rounded-lg">Fechar</button>
            </div>
        </div>
    </div>

    <script>
        const storyData = {
            start: {
                title: "001: ANSIEDADE ENTR√ìPICA",
                content: [
                    { type: "normal", text: "O escrit√≥rio era menos um espa√ßo e mais um monumento √† procrastina√ß√£o. Pilhas de ‚ú®<span class='examinable' data-term='livros de filosofia'>livros sobre filosofia existencial</span>‚ú® inclinavam-se em √¢ngulos que desafiavam a geometria, amea√ßando uma avalanche de conhecimento in√∫til. Na janela, uma ‚ú®<span class='examinable' data-term='samambaia'>samambaia</span>‚ú® solit√°ria, batizada de 'Nietzsche', tinha claramente desistido da fotoss√≠ntese por raz√µes ideol√≥gicas." },
                    { type: "monologue", text: "// MON√ìLOGO INTERNO: 'Devo arrumar a secret√°ria? Qual √© o objetivo? O universo tende para a entropia. Arrumar √© apenas... lutar contra a cosmologia. √â arrogante, se pensarmos bem. Quem sou eu para desafiar a segunda lei da termodin√¢mica com um espanador? √â como a arqueologia do dia-a-dia.'" }
                ],
                choices: [
                    { text: "O terminal pisca. Uma chamada encriptada rasga o sil√™ncio. Atender.", target: "crimeSceneIntro" }
                ],
                imagePrompt: "A detective's office, a monument to procrastination. Stacks of philosophy books lean precariously. A single, depressed-looking fern sits by the window.",
                imageOptions: [
                    { label: "Vis√£o Noir Cl√°ssica", director: "depalma", artist: "frank_miller_sc" },
                    { label: "Devaneio Surreal", director: "lynch", artist: "moebius" },
                    { label: "Ansiedade C√¥mica", director: "gilliam", artist: "addams" }
                ]
            },
            crimeSceneIntro: {
                title: "002: MORTE POR DESAPONTAMENTO",
                content: [
                    { type: "normal", text: "A chamada era sobre Alistair Finch. Colecionador de objetos que induzem melancolia, Finch fora encontrado morto. N√£o de forma violenta, mas... final. O seu apartamento, um santu√°rio g√≥tico ao bom gosto e √† tristeza, estava imaculado, exceto pelo ‚ú®<span class='examinable' data-term='pedestal vazio'>pedestal vazio</span>‚ú® no centro da sala. Finch jazia no ch√£o, abra√ßando o pedestal, o rosto congelado numa express√£o de desapontamento c√≥smico. O famoso √çdolo Dourado tinha desaparecido." },
                    { type: "monologue", text: "// MON√ìLOGO INTERNO: '√ìtimo. Um roubo. Provavelmente tenho de falar com pessoas. E olhar para... um corpo. Espero que ele tenha tido a dec√™ncia de n√£o ser demasiado gr√°fico. A morte √© de mau gosto. E se o assassino deixou impress√µes digitais? Eu n√£o trouxe luvas. Vou acabar por ser acusado, a explicar a um companheiro de cela chamado 'Brutus' a diferen√ßa entre Sartre e Camus.'" },
                    { type: "normal", text: "A cena do crime est√° √† sua frente, um quebra-cabe√ßas silencioso. Um ‚ú®<span class='examinable' data-term='guardanapo manchado'>guardanapo manchado</span>‚ú® de caf√© perto da lareira. Uma estranha ‚ú®<span class='examinable' data-term='esp√°tula de bolo vitoriana'>esp√°tula de bolo vitoriana</span>‚ú® no ch√£o. Como abordar esta tela de desespero?" }
                ],
                choices: [
                    { type: 'allen', text: "Focar-me nos absurdos l√≥gicos da cena. Tentar encontrar um padr√£o racional.", target: "pathAllen1", precogPrompt: "Analisar a l√≥gica de um guardanapo manchado." },
                    { type: 'burton', text: "Mergulhar na beleza m√≥rbida da atmosfera. Deixar que os objetos contem a sua hist√≥ria.", target: "pathBurton1", precogPrompt: "Sentir a hist√≥ria de uma esp√°tula de bolo vitoriana." }
                ],
                imagePrompt: "A lavish gothic apartment. A man in a velvet smoking jacket hugs an empty pedestal on the floor, his face a mask of cosmic disappointment.",
                 imageOptions: [
                    { label: "Pesadelo G√≥tico", director: "tim_burton", artist: "hellboy" },
                    { label: "Horror Pulp", director: "kubrick", artist: "ec_comics" },
                    { label: "Trag√©dia Distorcida", director: "lynch", artist: "junji_ito" }
                ]
            },
            pathAllen1: {
                title: "003A: A PISTA DO GUARDANAPO",
                content: [
                    { type: "normal", text: "O seu olhar evita a esp√°tula (t√©tano, maldi√ß√µes, o costume) e pousa no guardanapo. √â de um bar chamado 'O Paradoxo do Barman'. No guardanapo, um √∫nico anel de caf√© e uma frase rabiscada: 'O universo est√° a expandir-se, mas para onde? E ser√° que vai ligar quando chegar l√°?'." },
                    { type: "monologue", text: "// MON√ìLOGO INTERNO: 'Fant√°stico. Uma pista filos√≥fica. Isto √© in√∫til num tribunal. 'Merit√≠ssimo, o assassino √© claramente um agn√≥stico com uma dieta rica em condimentos'. Se o universo me ligasse, eu n√£o atenderia. Provavelmente seria a cobrar.'" }
                ],
                choices: [
                    { type: 'allen', text: "Ok, agora a esp√°tula. Com relut√¢ncia, claro.", target: "examineSpatula_fromAllen" },
                    { type: 'burton', text: "Esta nota √© triste. O que dir√° a esp√°tula?", target: "examineSpatula_fromAllen" }
                ],
                imagePrompt: "Close-up on a cocktail napkin on a dusty table. A single, sad coffee ring stains it. A philosophical question is scribbled on it.",
                 imageOptions: [
                    { label: "Foco Paranoico", director: "depalma", artist: "frank_miller_sc" },
                    { label: "Absurdo Minimalista", director: "gilliam", artist: "addams" },
                    { label: "Mist√©rio C√≥smico", director: "kubrick", artist: "moebius" }
                ]
            },
            pathBurton1: {
                title: "003B: A CAN√á√ÉO DA ESP√ÅTULA",
                content: [
                    { type: "normal", text: "Ignorando o rabisco existencial no guardanapo, os seus olhos s√£o atra√≠dos pela esp√°tula de bolo. √â uma pe√ßa vitoriana, a prata escurecida como um segredo. O cabo de madrep√©rola brilha com uma luz fraca e leitosa. N√£o parece uma arma, mas uma ferramenta para uma celebra√ß√£o solit√°ria." },
                    { type: "monologue", text: "// MON√ìLOGO INTERNO: 'Certo, √© um objeto bonito. Mas √© pr√°tico? E est√° frio. O tipo de frio que se sente quando se percebe que se esqueceu do anivers√°rio da pr√≥pria m√£e. Tocar nisto √© uma m√° ideia. √â assim que se acaba assombrado.'" }
                ],
                choices: [
                    { type: 'allen', text: "Certo, j√° vi o suficiente deste objeto assombrado. E o guardanapo?", target: "examineNapkin_fromBurton" },
                    { type: 'burton', text: "Esta beleza melanc√≥lica √© uma pista. Vejamos o guardanapo.", target: "examineNapkin_fromBurton" }
                ],
                imagePrompt: "An ornate Victorian cake spatula lies on a dark wooden floor. It's strangely menacing, with a patina of rust like dried blood.",
                imageOptions: [
                    { label: "Beleza Macabra", director: "tim_burton", artist: "ec_comics" },
                    { label: "Sonho Obscuro", director: "lynch", artist: "hellboy" },
                    { label: "Conto de Fadas Grotesco", director: "gilliam", artist: "junji_ito" }
                ]
            },
            examineSpatula_fromAllen: {
                title: "004A: REEXAME (L√ìGICO) DA ESP√ÅTULA",
                content: [
                    { type: "monologue", text: "// MON√ìLOGO INTERNO: 'Ok, respira fundo. √â s√≥ uma esp√°tula.' Voc√™ pega nela com a ponta dos dedos. √â estranhamente fria. A forma √© elegante, mas a ponta √© mais afiada do que deveria. A causa da morte de Finch, voc√™ conjetura, n√£o foi a esp√°tula, mas um caso agudo de auto-piedade. Uma arma do crime que me julga. Cada vez que olho para ela, sinto que devia ter aprendido a tocar violoncelo.'" }
                ],
                choices: [
                    { text: "Com duas pistas bizarras em m√£os, √© hora de sair deste apartamento deprimente.", target: "leaveScene" }
                ]
            },
             examineNapkin_fromBurton: {
                title: "004B: REEXAME (M√ìRBIDO) DO GUARDANAPO",
                content: [
                    { type: "normal", text: "Voc√™ pega no guardanapo. O papel √© de alta qualidade, mas a mancha de caf√© parece um olho a chorar uma l√°grima castanha. A frase, 'O universo est√° a expandir-se...', parece menos uma piada e mais um lamento sussurrado para o vazio. A mancha de mostarda, sob a luz fraca, parece um cometa a morrer." }
                ],
                choices: [
                    { text: "Com duas pistas po√©ticas e in√∫teis em m√£os, √© hora de abandonar este palco de trag√©dia.", target: "leaveScene" }
                ]
            },
            leaveScene: {
                title: "005: O PR√ìXIMO PASSO",
                content: [
                    { type: "normal", text: "De volta √†s ruas de Xangai, a cidade parece um sonho febril. Os arranha-c√©us arranham um c√©u da cor de um hematoma e os letreiros de n√©on sussurram promessas em mandarim que voc√™ n√£o compreende." },
                    { type: "normal", text: "Voc√™ tem duas pistas: um guardanapo com uma crise existencial e uma esp√°tula com depress√£o cl√≠nica. O que fazer agora?" }
                ],
                choices: [
                     { type: 'allen', text: "Ir ao 'Paradoxo do Barman'. Pelo menos pode haver √°lcool envolvido.", target: "barParadoxo", precogPrompt: "Visitar um bar onde os m√∫sicos n√£o fazem som." },
                     { type: 'burton', text: "Procurar a origem da esp√°tula. Mergulhar nas hist√≥rias esquecidas da cidade.", target: "antiquario", precogPrompt: "Perguntar a um velho sobre uma l√¢mina triste." }
                ]
            },
            barParadoxo: {
                title: "O PARADOXO DO BARMAN",
                content: [
                    { type: "normal", text: "O bar √© um 'Clube de Jazz Silencioso'. Os ‚ú®<span class='examinable' data-term='m√∫sicos silenciosos'>m√∫sicos</span>‚ú® no palco tocam com uma paix√£o febril, mas os seus instrumentos n√£o emitem som. A plateia assiste atentamente, estalando os dedos e aplaudindo em sil√™ncio absoluto. O ar √© denso de subtexto. O ‚ú®<span class='examinable' data-term='barman enigm√°tico'>barman</span>‚ú® limpa um copo com um pano que parece absorver a luz." },
                    { type: "monologue", text: "// MON√ìLOGO INTERNO: 'Claro. Porque n√£o? Um bar onde a principal atra√ß√£o √© o zumbido nos meus ouvidos. Isto n√£o √© um bar, √© uma met√°fora para as minhas rela√ß√µes. Todos falam, ningu√©m ouve.'" }
                ],
                choices: [ 
                    { text: "Deixar o bar e continuar a investigar.", target: "endSuspense" }
                ],
                characterInteraction: {
                    characterName: "O Barman",
                    systemPrompt: "Voc√™ √© o enigm√°tico barman do 'Paradoxo do Barman', um clube de jazz silencioso. Voc√™ fala apenas em met√°foras e enigmas po√©ticos. Voc√™ nunca d√° uma resposta direta. Voc√™ viu Alistair Finch na noite em que ele morreu. Ele estava ansioso, esperando por algu√©m que nunca chegou. Ele rabiscou algo num guardanapo. Responda √†s perguntas do detetive com este personagem em mente. Responda em portugu√™s."
                }
            },
            antiquario: {
                title: "A LOJA DE COISAS ESQUECIDAS",
                content: [
                    { type: "normal", text: "O antiqu√°rio cheira a tempo. O ‚ú®<span class='examinable' data-term='dono do antiqu√°rio'>propriet√°rio</span>‚ú® √© um homem velho com olhos que parecem ter visto o nascer e o morrer de estrelas. Ele olha para a esp√°tula e sorri um sorriso triste. 'Ah, sim. A 'L√¢mina do Anivers√°rio Solit√°rio'. Diz-se que foi usada para cortar o bolo no √∫ltimo anivers√°rio de Edgar Allan Poe. Ele n√£o comeu nenhuma fatia.'" },
                    { type: "monologue", text: "// MON√ìLOGO INTERNO: 'Edgar Allan Poe. Claro. Porque n√£o o bolo de casamento de Medusa? Seria mais alegre. A minha vida √© um conto g√≥tico escrito por um comediante que est√° a passar por um div√≥rcio complicado.'" }
                ],
                choices: [ 
                    { text: "Agradecer ao velho e sair para a noite.", target: "endSuspense" }
                ],
                characterInteraction: {
                    characterName: "O Dono do Antiqu√°rio",
                    systemPrompt: "Voc√™ √© o velho e poeirento dono de um antiqu√°rio. Voc√™ conhece a hist√≥ria sombria de cada objeto na sua loja. Voc√™ fala de forma lenta e melanc√≥lica, como se cada palavra fosse um esfor√ßo. Voc√™ sabe que a esp√°tula pertenceu a uma sociedade secreta de 'Estetas da Entropia', que acreditam que a beleza s√≥ pode ser encontrada na decad√™ncia e no desapontamento. Alistair Finch era um membro. Responda √†s perguntas do detetive com este personagem em mente. Responda em portugu√™s."
                }
            },
            endSuspense: {
                title: "AGUARDE...",
                content: [
                    { type: "normal", text: "As pistas flutuam na sua mente como fumo de cigarro numa sala mal iluminada. Um guardanapo, uma esp√°tula, um barman silencioso... as pe√ßas est√£o no tabuleiro, mas a imagem que formam √© um absurdo. A noite ainda √© uma crian√ßa, e os seus segredos s√£o profundos." },
                    { type: "monologue", text: "// MON√ìLOGO INTERNO: 'Ser√° que algum dia isto far√° sentido? Ou ser√° que o sentido √© a pr√≥pria falta dele? Talvez eu devesse ter sido contabilista. Pelo menos os n√∫meros n√£o t√™m crises existenciais.'" }
                ],
                choices: [ { text: "FIM DO EPIS√ìDIO 1. REINICIAR?", target: "start" } ]
            }
        };

        const artistStyles = {
            "frank_miller_sc": { name: "F. Miller (Sin City)", prompt: "in the stark, high-contrast, black-and-white neo-noir style of Frank Miller's Sin City, with minimalist backgrounds and selective use of color." },
            "frank_miller_tdkr": { name: "F. Miller (Cav. Trevas)", prompt: "in the gritty, ink-heavy, and dystopian style of Frank Miller's The Dark Knight Returns, with bulky figures and a sense of decay." },
            "moebius": { name: "Moebius", prompt: "in the intricate, clean-lined, and surreal sci-fi fantasy style of Jean Giraud 'Moebius', with imaginative landscapes and a sense of wonder." },
            "junji_ito": { name: "Junji Ito", prompt: "in the terrifying body horror and cosmic dread style of manga artist Junji Ito, with detailed, disturbing imagery and unsettling spiral patterns." },
            "alex_ross": { name: "Alex Ross", prompt: "in the photorealistic, painterly, and heroic style of Alex Ross, with dramatic lighting and a sense of classical grandeur." },
            "john_byrne": { name: "John Byrne", prompt: "in the clean, classic, and dynamic superhero comic book style of John Byrne from the 1980s, with strong character poses and clear storytelling." },
            "jack_kirby": { name: "Jack Kirby", prompt: "in the bold, powerful, and cosmic style of Jack Kirby, with dynamic action, 'Kirby Krackle' energy effects, and blocky, powerful figures." },
            "hanna_barbera": { name: "Hanna-Barbera", prompt: "in the simple, charming, and flat-colored style of a classic Hanna-Barbera cartoon from the 1960s, like 'Scooby-Doo', with a friendly and non-threatening feel." },
            "hellboy": { name: "Estilo 'Hellboy'", prompt: "in the distinct art style of Mike Mignola's Hellboy comics, with heavy use of black ink, dramatic shadows, and blocky, stylized figures." },
            "ec_comics": { name: "Estilo 'EC Comics'", prompt: "in the style of a vintage EC Comics horror cover from the 1950s, like 'Tales from the Crypt', with detailed, lurid line work and a sense of suspenseful dread." }
        };

        const directorStyles = {
            "tim_burton": { name: "Tim Burton", prompt: "The scene is depicted with a Tim Burton-esque gothic fairytale aesthetic, featuring distorted perspectives, whimsical yet macabre characters, and a dark, magical atmosphere." },
            "kubrick": { name: "S. Kubrick", prompt: "The scene is framed with Kubrickian precision, emphasizing one-point perspective, unsettling symmetry, and a cold, detached atmosphere." },
            "depalma": { name: "B. De Palma", prompt: "The scene is captured with a De Palma-esque split-screen or a slow, voyeuristic tracking shot, building suspense and a sense of paranoia." },
            "lynch": { name: "D. Lynch", prompt: "The scene is depicted through a Lynchian lens, where the mundane becomes surreal and menacing, with strange textures, distorted sounds, and a dreamlike, illogical quality." },
            "gilliam": { name: "T. Gilliam", prompt: "The scene is viewed through a Terry Gilliam-style wide-angle lens, distorting the edges and filling the frame with bizarre, cluttered details and a sense of anarchic energy." }
        };

        let gameState = { currentScene: 'start', currentImagePrompt: '', audioPlayer: null, audioUrl: null, chatHistory: [], currentTheme: 'allen', userApiKey: '' };
        let typewriterInterval;
        let sounds;
        let isTypingSoundBusy = false;

        const startScreen = document.getElementById('start-screen');
        const gameScreen = document.getElementById('game-screen');
        const startButton = document.getElementById('start-button');
        const sceneTitle = document.getElementById('scene-title');
        const sceneContent = document.getElementById('scene-content');
        const choicesContainer = document.getElementById('choices-container');
        const ttsControls = document.getElementById('tts-controls');
        
        const precogModal = document.getElementById('precog-modal');
        const precogContent = document.getElementById('precog-content');
        const modalClosePrecogButton = document.getElementById('modal-close-precog-button');

        const investigationModal = document.getElementById('investigation-modal');
        const investigationTitle = document.getElementById('investigation-title');
        const investigationContent = document.getElementById('investigation-content');
        const modalCloseInvestigationButton = document.getElementById('modal-close-investigation-button');

        const characterChatModal = document.getElementById('character-chat-modal');
        const chatTitle = document.getElementById('chat-title');
        const chatLog = document.getElementById('chat-log');
        const chatInput = document.getElementById('chat-input');
        const chatSendButton = document.getElementById('chat-send-button');
        const modalCloseChatButton = document.getElementById('modal-close-chat-button');

        const apiKeyModal = document.getElementById('api-key-modal');
        const apiKeyButton = document.getElementById('api-key-button');
        const apiKeyInput = document.getElementById('api-key-input');
        const saveApiKeyButton = document.getElementById('save-api-key-button');
        const closeApiKeyModalButton = document.getElementById('close-api-key-modal');

        const imagePanel = document.getElementById('image-panel');
        const imageContainer = document.getElementById('image-container');
        const imageDisplayArea = document.getElementById('image-display-area');
        const imageOptionsContainer = document.getElementById('image-options-container');
        const fullscreenButton = document.getElementById('fullscreen-button');
        const downloadLink = document.getElementById('download-link');

        function setupSounds() {
            sounds = {
                click: new Tone.Synth({ oscillator: { type: 'sine' }, envelope: { attack: 0.005, decay: 0.1, sustain: 0.3, release: 1 } }).toDestination(),
                type: new Tone.NoiseSynth({ noise: { type: 'brown' }, envelope: { attack: 0.005, decay: 0.05, sustain: 0 } }).toDestination(),
                precog: new Tone.AMSynth({ harmonicity: 1.5, envelope: { attack: 0.1, decay: 0.2, sustain: 0.1, release: 0.5 } }).toDestination(),
                investigate: new Tone.MembraneSynth().toDestination(),
                imageGen: new Tone.FMSynth({ harmonicity: 0.8, modulationIndex: 7, envelope: { attack: 0.1, decay: 0.5 } }).toDestination(),
                ttsGen: new Tone.PluckSynth().toDestination()
            };
            sounds.type.volume.value = -20;
        }
        
        function typeWriter(element, html, onComplete) {
            if (typewriterInterval) clearInterval(typewriterInterval);
            element.innerHTML = html;
            element.classList.add('typing-effect');

            const allTextNodes = [];
            function getTextNodes(node) {
                if (node.nodeType === 3) {
                    allTextNodes.push(node);
                } else if (node.nodeType === 1 && node.childNodes) {
                    for (let i = 0; i < node.childNodes.length; i++) {
                        getTextNodes(node.childNodes[i]);
                    }
                }
            }
            
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = html;
            
            const originalNodes = Array.from(tempDiv.childNodes);
            element.innerHTML = '';

            let nodeIndex = 0;
            function processNode() {
                if (nodeIndex < originalNodes.length) {
                    const node = originalNodes[nodeIndex].cloneNode(true);
                    element.appendChild(node);
                    
                    if (node.nodeType === 3) { // Text node
                        const text = node.textContent;
                        node.textContent = '';
                        let charIndex = 0;
                        const interval = setInterval(() => {
                            if (charIndex < text.length) {
                                node.textContent += text[charIndex];
                                if (text[charIndex].trim() !== '' && sounds && !isTypingSoundBusy) {
                                    isTypingSoundBusy = true;
                                    sounds.type.triggerAttackRelease("8n", Tone.now());
                                    setTimeout(() => { isTypingSoundBusy = false; }, 50);
                                }
                                charIndex++;
                            } else {
                                clearInterval(interval);
                                nodeIndex++;
                                processNode();
                            }
                        }, 30);
                    } else { // Element node
                        nodeIndex++;
                        processNode();
                    }
                } else {
                    element.classList.remove('typing-effect');
                    if (onComplete) onComplete();
                }
            }
            processNode();
        }


        function renderScene(sceneId) {
            const scene = storyData[sceneId];
            if (!scene) return;
            
            if(gameState.audioPlayer) {
                gameState.audioPlayer.pause();
                gameState.audioPlayer = null;
                URL.revokeObjectURL(gameState.audioUrl);
                gameState.audioUrl = null;
            }

            gameState.currentScene = sceneId;
            gameState.currentImagePrompt = scene.imagePrompt || '';
            
            sceneTitle.textContent = scene.title;
            sceneContent.innerHTML = '';
            choicesContainer.innerHTML = '';
            renderTTSControls();
            
            let contentIndex = 0;
            function showNextContent() {
                if(contentIndex < scene.content.length) {
                    const contentItem = scene.content[contentIndex];
                    const p = document.createElement('p');
                    if (contentItem.type === 'monologue') {
                        p.className = 'text-gray-500 italic';
                    }
                    
                    sceneContent.appendChild(p);
                    
                    typeWriter(p, contentItem.text, showNextContent);
                    contentIndex++;
                } else {
                    renderChoices(scene.choices);
                    if (scene.imagePrompt) {
                        imagePanel.classList.remove('hidden');
                        imageDisplayArea.innerHTML = '<p class="text-gray-500 text-sm p-4 text-center">Escolha uma vis√£o para gerar uma ilustra√ß√£o.</p>';
                        fullscreenButton.classList.add('hidden');
                        downloadLink.classList.add('hidden');
                        renderImageOptions();
                    } else {
                        imagePanel.classList.add('hidden');
                    }
                }
            }
            showNextContent();
        }

        function renderChoices(choices) {
             const scene = storyData[gameState.currentScene];
             if (scene.characterInteraction) {
                const button = document.createElement('button');
                button.className = 'w-full p-4 rounded-none shadow-md text-left text-lg choice-button';
                button.innerHTML = `‚ú® <span class="font-bold">[INTERROGAR]</span> Falar com ${scene.characterInteraction.characterName}`;
                button.onclick = () => handleCharacterInteraction(scene.characterInteraction);
                choicesContainer.appendChild(button);
             }

             choices.forEach(choice => {
                const choiceWrapper = document.createElement('div');
                choiceWrapper.className = 'flex items-stretch';

                const mainButton = document.createElement('button');
                const buttonClass = 'w-full p-4 rounded-none shadow-md text-left text-lg';
                
                if (choice.type) {
                    mainButton.className = `${buttonClass} choice-button-${choice.type}`;
                    mainButton.innerHTML = `<span class="font-bold">[PERSPECTIVA ${choice.type === 'allen' ? 'NEUR√ìTICA' : 'G√ìTICA'}]</span> ${choice.text}`;
                    mainButton.onclick = () => {
                        sounds.click.triggerAttackRelease("C4", "8n");
                        gameState.currentTheme = choice.type;
                        document.body.className = `antialiased theme-${gameState.currentTheme}`;
                        renderScene(choice.target);
                    };
                } else {
                    mainButton.className = `${buttonClass} choice-button`;
                    mainButton.innerHTML = `<span class="font-bold">[A√á√ÉO]</span> ${choice.text}`;
                    mainButton.onclick = () => {
                        sounds.click.triggerAttackRelease("C4", "8n");
                        renderScene(choice.target);
                    };
                }
                choiceWrapper.appendChild(mainButton);
                
                if (choice.precogPrompt) {
                    const precogButton = document.createElement('button');
                    precogButton.className = 'gemini-button flex-shrink-0 p-3 rounded-none shadow-lg';
                    precogButton.title = '‚ú® Usar Precogni√ß√£o';
                    precogButton.innerHTML = `‚ú®`;
                    precogButton.onclick = () => handlePrecognition(choice.precogPrompt);
                    choiceWrapper.appendChild(precogButton);
                }

                choicesContainer.appendChild(choiceWrapper);
            });
        }

        async function handlePrecognition(prompt) {
            sounds.precog.triggerAttackRelease("A#2", "0.5");
            precogModal.style.display = 'flex';
            precogContent.innerHTML = '<div class="flex justify-center items-center h-full"><div class="spinner"></div></div>';

            const fullPrompt = `Como um detetive noir com habilidades ps√≠quicas, voc√™ tem um flash de insight sobre a a√ß√£o: '${prompt}'. Descreva essa vis√£o enigm√°tica em uma ou duas frases curtas, po√©ticas e agourentas. A situa√ß√£o atual √©: '${storyData[gameState.currentScene].title}'. Responda em portugu√™s.`;
            
            let chatHistory = [{ role: "user", parts: [{ text: fullPrompt }] }];
            const payload = { contents: chatHistory };
            const apiKey = gameState.userApiKey;
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                if (result.candidates && result.candidates.length > 0 && result.candidates[0].content.parts.length > 0) {
                    const precogText = result.candidates[0].content.parts[0].text;
                    typeWriter(precogContent, precogText);
                } else {
                    throw new Error("Resposta da API inv√°lida.");
                }
            } catch (error) {
                console.error("Erro na Precogni√ß√£o:", error);
                precogContent.textContent = "As est√°ticas do futuro s√£o indecifr√°veis.";
                if (error instanceof TypeError) {
                    apiKeyModal.style.display = 'flex';
                }
            }
        }

        async function handleInvestigation(term) {
            sounds.investigate.triggerAttackRelease("C2", "8n");
            investigationModal.style.display = 'flex';
            investigationTitle.textContent = `INVESTIGANDO: ${term.toUpperCase()}`;
            investigationContent.innerHTML = '<div class="flex justify-center items-center h-full"><div class="spinner"></div></div>';
            
            const fullPrompt = `Voc√™ √© o mestre de um jogo de RPG de mist√©rio noir com um tom de com√©dia sombria e absurda. O jogador quer investigar um objeto ou conceito espec√≠fico da cena. Forne√ßa uma descri√ß√£o detalhada, po√©tica e ligeiramente filos√≥fica para o seguinte item: '${term}'. O contexto da cena atual √©: '${storyData[gameState.currentScene].title}'. Mantenha o tom e o estilo da aventura. Responda em portugu√™s.`;

            let chatHistory = [{ role: "user", parts: [{ text: fullPrompt }] }];
            const payload = { contents: chatHistory };
            const apiKey = gameState.userApiKey;
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                if (result.candidates && result.candidates.length > 0 && result.candidates[0].content.parts.length > 0) {
                    const investigationText = result.candidates[0].content.parts[0].text;
                    typeWriter(investigationContent, investigationText);
                } else {
                    throw new Error("Resposta da API inv√°lida.");
                }
            } catch (error) {
                console.error("Erro na Investiga√ß√£o:", error);
                investigationContent.textContent = "A sua mente tenta focar-se no objeto, mas s√≥ encontra um vazio existencial.";
                 if (error instanceof TypeError) {
                    apiKeyModal.style.display = 'flex';
                }
            }
        }
        
        function handleCharacterInteraction(characterData) {
            sounds.click.triggerAttackRelease("E4", "8n");
            chatTitle.textContent = `CONVERSANDO COM: ${characterData.characterName.toUpperCase()}`;
            chatLog.innerHTML = '';
            chatInput.value = '';
            gameState.chatHistory = [{ role: "user", parts: [{ text: characterData.systemPrompt }] }];
            characterChatModal.style.display = 'flex';
        }

        async function sendChatMessage() {
            const userMessage = chatInput.value.trim();
            if (userMessage === '') return;

            chatInput.value = '';
            addMessageToChatLog('Voc√™', userMessage);

            gameState.chatHistory.push({ role: "user", parts: [{ text: userMessage }] });

            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'text-left mb-2';
            loadingDiv.innerHTML = `<p class="font-bold text-gray-500">_</p><div class="p-2 rounded-md bg-gray-200 inline-block"><div class="spinner w-4 h-4"></div></div>`;
            chatLog.appendChild(loadingDiv);
            chatLog.scrollTop = chatLog.scrollHeight;

            const payload = { contents: gameState.chatHistory };
            const apiKey = gameState.userApiKey;
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                loadingDiv.remove();
                if (result.candidates && result.candidates.length > 0 && result.candidates[0].content.parts.length > 0) {
                    const characterResponse = result.candidates[0].content.parts[0].text;
                    gameState.chatHistory.push({ role: "model", parts: [{ text: characterResponse }] });
                    addMessageToChatLog(storyData[gameState.currentScene].characterInteraction.characterName, characterResponse);
                } else {
                    throw new Error("Resposta da API inv√°lida.");
                }
            } catch (error) {
                console.error("Erro no Chat:", error);
                loadingDiv.remove();
                addMessageToChatLog("Sistema", "A conex√£o com a consci√™ncia do personagem foi perdida...");
                 if (error instanceof TypeError) {
                    apiKeyModal.style.display = 'flex';
                }
            }
        }

        function addMessageToChatLog(sender, message) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `text-left mb-2 ${sender === 'Voc√™' ? 'text-right' : ''}`;
            messageDiv.innerHTML = `<p class="font-bold text-sm ${sender === 'Voc√™' ? 'text-blue-500' : 'text-purple-600'}">${sender}</p><p class="p-2 rounded-md inline-block ${sender === 'Voc√™' ? 'bg-blue-100' : 'bg-purple-100'}">${message}</p>`;
            chatLog.appendChild(messageDiv);
            chatLog.scrollTop = chatLog.scrollHeight;
        }


        async function handleImageGeneration(director, artist) {
            sounds.imageGen.triggerAttackRelease("C2", "1s");
            imageDisplayArea.innerHTML = '<div class="flex flex-col items-center gap-2"><div class="spinner"></div><p>Gerando ilustra√ß√£o...</p></div>';
            fullscreenButton.classList.add('hidden');
            downloadLink.classList.add('hidden');
            
            const fullPrompt = `${gameState.currentImagePrompt}, ${directorStyles[director].prompt}, ${artistStyles[artist].prompt}`;
            
            const payload = { instances: [{ prompt: fullPrompt }], parameters: { "sampleCount": 1 } };
            const apiKey = gameState.userApiKey;
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict?key=${apiKey}`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                if (result.predictions && result.predictions.length > 0 && result.predictions[0].bytesBase64Encoded) {
                    const imageUrl = `data:image/png;base64,${result.predictions[0].bytesBase64Encoded}`;
                    imageDisplayArea.innerHTML = `<img src="${imageUrl}" class="w-full h-full object-contain" alt="Ilustra√ß√£o da cena gerada por IA">`;
                    downloadLink.href = imageUrl;
                    fullscreenButton.classList.remove('hidden');
                    downloadLink.classList.remove('hidden');
                } else {
                    throw new Error("Resposta da API inv√°lida ou sem imagem.");
                }
            } catch (error) {
                console.error("Erro ao gerar imagem:", error);
                imageDisplayArea.innerHTML = `<p class="text-red-500 p-4 text-center">Falha na gera√ß√£o da imagem. Verifique a sua chave de API ou a conex√£o.</p>`;
                 if (error instanceof TypeError || (error.message && (error.message.includes("401") || error.message.includes("400")))) {
                    apiKeyModal.style.display = 'flex';
                }
            }
        }
        
        function renderImageOptions() {
            const scene = storyData[gameState.currentScene];
            imageOptionsContainer.innerHTML = '';
            if (scene.imageOptions) {
                scene.imageOptions.forEach(option => {
                    const button = document.createElement('button');
                    button.className = 'w-full p-3 choice-button rounded-lg text-sm';
                    button.textContent = `Vis√£o: ${option.label}`;
                    button.onclick = () => handleImageGeneration(option.director, option.artist);
                    imageOptionsContainer.appendChild(button);
                });
            }
        }
        
        function base64ToArrayBuffer(base64) {
            const binaryString = window.atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }

        function pcmToWav(pcmData, sampleRate) {
            const numChannels = 1;
            const bytesPerSample = 2;
            const blockAlign = numChannels * bytesPerSample;
            const byteRate = sampleRate * blockAlign;
            const dataSize = pcmData.length * bytesPerSample;
            const buffer = new ArrayBuffer(44 + dataSize);
            const view = new DataView(buffer);

            function writeString(view, offset, string) {
                for (let i = 0; i < string.length; i++) {
                    view.setUint8(offset + i, string.charCodeAt(i));
                }
            }

            writeString(view, 0, 'RIFF');
            view.setUint32(4, 36 + dataSize, true);
            writeString(view, 8, 'WAVE');
            writeString(view, 12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true);
            view.setUint16(22, numChannels, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, byteRate, true);
            view.setUint16(32, blockAlign, true);
            view.setUint16(34, 16, true);
            writeString(view, 36, 'data');
            view.setUint32(40, dataSize, true);

            for (let i = 0; i < pcmData.length; i++) {
                view.setInt16(44 + i * 2, pcmData[i], true);
            }

            return new Blob([view], { type: 'audio/wav' });
        }

        async function handleTTSGeneration() {
            const button = document.getElementById('tts-button');
            button.innerHTML = '<div class="spinner w-5 h-5"></div>';
            button.disabled = true;
            
            sounds.ttsGen.triggerAttackRelease("C4", "8n");

            const scene = storyData[gameState.currentScene];
            let ttsScript = "TTS the following conversation between Narrador and Mon√≥logo Interno:\n";
            scene.content.forEach(part => {
                const speaker = part.type === 'normal' ? 'Narrador' : 'Mon√≥logo Interno';
                const text = part.text.replace(/\/\/\s*MON√ìLOGO INTERNO:\s*/, '').replace(/<[^>]*>/g, '');
                ttsScript += `${speaker}: ${text}\n`;
            });

            const payload = {
                contents: [{ parts: [{ text: ttsScript }] }],
                generationConfig: {
                    responseModalities: ["AUDIO"],
                    speechConfig: {
                        multiSpeakerVoiceConfig: {
                            speakerVoiceConfigs: [
                                { speaker: "Narrador", voiceConfig: { prebuiltVoiceConfig: { voiceName: "Rasalgethi" } } },
                                { speaker: "Mon√≥logo Interno", voiceConfig: { prebuiltVoiceConfig: { voiceName: "Zubenelgenubi" } } }
                            ]
                        }
                    }
                },
                model: "gemini-2.5-flash-preview-tts"
            };
            const apiKey = gameState.userApiKey;
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                const part = result?.candidates?.[0]?.content?.parts?.[0];
                const audioData = part?.inlineData?.data;
                const mimeType = part?.inlineData?.mimeType;

                if (audioData && mimeType && mimeType.startsWith("audio/")) {
                    const sampleRate = parseInt(mimeType.match(/rate=(\d+)/)[1], 10);
                    const pcmData = base64ToArrayBuffer(audioData);
                    const pcm16 = new Int16Array(pcmData);
                    const wavBlob = pcmToWav(pcm16, sampleRate);
                    gameState.audioUrl = URL.createObjectURL(wavBlob);
                    gameState.audioPlayer = new Audio(gameState.audioUrl);
                    gameState.audioPlayer.play();
                    button.innerHTML = '‚ùö‚ùö'; // Pause
                    button.disabled = false;
                    gameState.audioPlayer.onended = () => {
                        button.innerHTML = '‚ñ∂'; // Play
                    };
                } else {
                    throw new Error("Dados de √°udio inv√°lidos na resposta.");
                }
            } catch (error) {
                console.error("Erro ao gerar TTS:", error);
                button.innerHTML = '‚ñ∂';
                button.disabled = false;
                 if (error instanceof TypeError) {
                    apiKeyModal.style.display = 'flex';
                }
            }
        }

        function renderTTSControls() {
            ttsControls.innerHTML = '';
            const button = document.createElement('button');
            button.id = 'tts-button';
            button.className = 'gemini-button p-2 rounded-full';
            button.title = '‚ú® Ouvir Cena';
            button.innerHTML = '‚ñ∂'; // Play icon
            button.onclick = () => {
                if (!gameState.audioPlayer) {
                    handleTTSGeneration();
                } else if (gameState.audioPlayer.paused) {
                    gameState.audioPlayer.play();
                    button.innerHTML = '‚ùö‚ùö'; // Pause
                } else {
                    gameState.audioPlayer.pause();
                    button.innerHTML = '‚ñ∂'; // Play
                }
            };
            ttsControls.appendChild(button);
        }

        function hidePrecogModal() {
            sounds.click.triggerAttackRelease("A3", "8n");
            precogModal.style.display = 'none';
        }
        
        function hideInvestigationModal() {
            sounds.click.triggerAttackRelease("A3", "8n");
            investigationModal.style.display = 'none';
        }

        function hideChatModal() {
            sounds.click.triggerAttackRelease("A3", "8n");
            characterChatModal.style.display = 'none';
        }

        startButton.addEventListener('click', async () => {
            await Tone.start();
            setupSounds();
            sounds.click.triggerAttackRelease("G4", "8n");
            document.body.className = 'antialiased theme-allen';
            startScreen.style.display = 'none';
            gameScreen.style.display = 'block';
            renderScene('start');
        });

        modalClosePrecogButton.addEventListener('click', hidePrecogModal);
        precogModal.addEventListener('click', (e) => { if (e.target === precogModal) hidePrecogModal(); });

        modalCloseInvestigationButton.addEventListener('click', hideInvestigationModal);
        investigationModal.addEventListener('click', (e) => { if (e.target === investigationModal) hideInvestigationModal(); });

        chatSendButton.addEventListener('click', sendChatMessage);
        chatInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') sendChatMessage(); });
        modalCloseChatButton.addEventListener('click', hideChatModal);

        sceneContent.addEventListener('click', (e) => {
            if (e.target.classList.contains('examinable')) {
                const term = e.target.dataset.term;
                handleInvestigation(term);
            }
        });
        
        fullscreenButton.addEventListener('click', () => {
            const imgElement = imageDisplayArea.querySelector('img');
            if (imgElement && imgElement.requestFullscreen) {
                imgElement.requestFullscreen();
            }
        });

        apiKeyButton.addEventListener('click', () => apiKeyModal.style.display = 'flex');
        closeApiKeyModalButton.addEventListener('click', () => apiKeyModal.style.display = 'none');
        saveApiKeyButton.addEventListener('click', () => {
            gameState.userApiKey = apiKeyInput.value.trim();
            apiKeyModal.style.display = 'none';
        });

    </script>
</body>
</html>
